{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kloc.dev/schemas/sot-json.json",
  "title": "Source-of-Truth JSON (sot.json)",
  "description": "Schema for kloc-mapper output / kloc-cli input. Defines the SoT graph with typed nodes and edges.",
  "type": "object",
  "required": ["version", "metadata", "nodes", "edges"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "description": "Schema version.",
      "const": "2.0"
    },
    "metadata": {
      "type": "object",
      "description": "Pipeline metadata.",
      "required": ["generated_at", "source_scip", "project_root"],
      "additionalProperties": false,
      "properties": {
        "generated_at": {
          "type": "string",
          "description": "ISO 8601 timestamp of generation."
        },
        "source_scip": {
          "type": "string",
          "description": "Name of the source SCIP index file."
        },
        "project_root": {
          "type": "string",
          "description": "URI of the project root used during indexing."
        }
      }
    },
    "nodes": {
      "type": "array",
      "description": "All nodes in the SoT graph.",
      "items": { "$ref": "#/$defs/Node" }
    },
    "edges": {
      "type": "array",
      "description": "All edges in the SoT graph.",
      "items": { "$ref": "#/$defs/Edge" }
    }
  },
  "$defs": {
    "NodeKind": {
      "type": "string",
      "description": "Node kind enum — 13 values from kloc-mapper/src/models.py:NodeKind.",
      "enum": [
        "File",
        "Class",
        "Interface",
        "Trait",
        "Enum",
        "Method",
        "Function",
        "Property",
        "Const",
        "Argument",
        "EnumCase",
        "Value",
        "Call"
      ]
    },
    "EdgeType": {
      "type": "string",
      "description": "Edge type enum — 12 values from kloc-mapper/src/models.py:EdgeType.",
      "enum": [
        "contains",
        "extends",
        "implements",
        "uses_trait",
        "overrides",
        "uses",
        "type_hint",
        "calls",
        "receiver",
        "argument",
        "produces",
        "assigned_from",
        "type_of"
      ]
    },
    "Range": {
      "type": "object",
      "description": "Source code range (line/col are 0-based).",
      "required": ["start_line", "start_col", "end_line", "end_col"],
      "additionalProperties": false,
      "properties": {
        "start_line": { "type": "integer" },
        "start_col": { "type": "integer" },
        "end_line": { "type": "integer" },
        "end_col": { "type": "integer" }
      }
    },
    "Location": {
      "type": "object",
      "description": "Source location (file + line + col).",
      "required": ["file", "line"],
      "additionalProperties": false,
      "properties": {
        "file": { "type": "string" },
        "line": { "type": "integer" },
        "col": { "type": "integer", "default": 0 }
      }
    },
    "Node": {
      "type": "object",
      "description": "A node in the SoT graph.",
      "required": ["id", "kind", "name", "fqn", "symbol", "file", "range", "enclosing_range", "documentation"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Deterministic node ID (e.g. 'node:abc123', 'node:val:abc123', 'node:call:abc123')."
        },
        "kind": { "$ref": "#/$defs/NodeKind" },
        "name": {
          "type": "string",
          "description": "Short name of the symbol."
        },
        "fqn": {
          "type": "string",
          "description": "Fully qualified name."
        },
        "symbol": {
          "type": "string",
          "description": "SCIP symbol string (may be empty for Call nodes)."
        },
        "file": {
          "type": ["string", "null"],
          "description": "Relative file path. Null for external symbols."
        },
        "range": {
          "oneOf": [
            { "$ref": "#/$defs/Range" },
            { "type": "null" }
          ],
          "description": "Definition range. Null when unavailable."
        },
        "enclosing_range": {
          "oneOf": [
            { "$ref": "#/$defs/Range" },
            { "type": "null" }
          ],
          "description": "Enclosing range (e.g. full method body). Null for many node kinds."
        },
        "documentation": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Documentation strings from SCIP index."
        },
        "value_kind": {
          "type": "string",
          "description": "Only set when kind == 'Value'. One of: parameter, local, result, literal, constant.",
          "enum": ["parameter", "local", "result", "literal", "constant"]
        },
        "type_symbol": {
          "type": "string",
          "description": "Only set when kind == 'Value'. SCIP symbol of the value's type."
        },
        "call_kind": {
          "type": "string",
          "description": "Only set when kind == 'Call'. One of: method, method_static, constructor, access, access_static, function.",
          "enum": ["method", "method_static", "constructor", "access", "access_static", "function"]
        }
      }
    },
    "Edge": {
      "type": "object",
      "description": "An edge in the SoT graph. Argument edges may include a 'parameter' field linking to the formal parameter FQN.",
      "required": ["type", "source", "target"],
      "additionalProperties": false,
      "properties": {
        "type": { "$ref": "#/$defs/EdgeType" },
        "source": {
          "type": "string",
          "description": "Source node ID."
        },
        "target": {
          "type": "string",
          "description": "Target node ID."
        },
        "location": {
          "$ref": "#/$defs/Location",
          "description": "Source location for 'uses' edges."
        },
        "position": {
          "type": "integer",
          "description": "0-based argument index for 'argument' edges."
        },
        "expression": {
          "type": "string",
          "description": "Source expression text for 'argument' edges (e.g. '$input->productId', 'new DateTimeImmutable()')."
        },
        "parameter": {
          "type": "string",
          "description": "FQN of the formal parameter for 'argument' edges. Resolved from scip-php parameter symbol."
        }
      }
    }
  }
}
